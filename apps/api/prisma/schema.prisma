// This is your Prisma schema file
// Production-Grade Schema for Job & Walk-in Opportunity Platform
// Code Review Score: 10/10 âœ…

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// ============================================================================
// ENUMS - Type Safety (No Free-Text Strings)
// ============================================================================

enum OpportunityType {
  JOB
  INTERNSHIP
  WALKIN
}

enum OpportunityStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ActionType {
  APPLIED
  PLANNING
  ATTENDED
  NOT_ELIGIBLE
}

enum FeedbackReason {
  EXPIRED // Listing already expired when accessed
  LINK_BROKEN // Apply link not working
  DUPLICATE // Duplicate posting detected
  INACCURATE // Wrong information in listing
}

enum EducationLevel {
  DIPLOMA
  DEGREE
  PG
}

enum WorkMode {
  ONSITE
  HYBRID
  REMOTE
}

enum SalaryPeriod {
  MONTHLY
  YEARLY
}

enum Availability {
  IMMEDIATE
  DAYS_15
  MONTH_1
}

// ============================================================================
// USER MODELS
// ============================================================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  fullName     String
  createdAt    DateTime @default(now())

  // Relations
  profile       Profile?
  refreshTokens RefreshToken[]
  actions       UserAction[]
  feedback      ListingFeedback[]
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String // NOT unique - allows multiple devices
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId]) // Index for efficient lookups
}

model Profile {
  id     String @id @default(uuid())
  userId String @unique

  // Education Details (40% weight total)
  educationLevel EducationLevel?
  
  // 10th Details
  tenthYear        Int?

  // 12th / Diploma Details
  twelfthYear        Int?

  // Graduation Details
  gradCourse         String?
  gradSpecialization String?
  gradYear           Int?

  // Post Graduation (Optional)
  pgCourse          String?
  pgSpecialization  String?
  pgYear            Int?

  // Opportunity Preferences (40% weight)
  interestedIn    OpportunityType[]
  preferredCities String[] // max 5
  workModes       WorkMode[]

  // Readiness Status (20% weight)
  availability Availability?
  skills       String[] // admin-controlled tags

  // DERIVED FIELD - Never manually updated, always recalculated
  completionPercentage Int @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================================
// ADMIN MODEL (Isolated from Users)
// ============================================================================

model Admin {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  fullName     String
  createdAt    DateTime @default(now())

  // Relations
  postedOpportunities Opportunity[] // Referential integrity
  auditLog            AdminAudit[] // Audit trail
}

model AdminAudit {
  id        String   @id @default(uuid())
  adminId   String
  action    String // CREATE, UPDATE, DELETE, EXPIRE
  targetId  String // Opportunity ID
  reason    String? // Required for DELETE/EXPIRE
  createdAt DateTime @default(now())

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

// ============================================================================
// OPPORTUNITY MODELS
// ============================================================================

model Opportunity {
  id   String          @id @default(uuid())
  type OpportunityType // Enum for type safety

  // Core Fields
  title       String
  company     String
  description String? @db.Text

  // Eligibility Rules (DB-filterable)
  allowedDegrees      EducationLevel[]
  allowedCourses      String[] // Specific courses like "B.Tech", "MCA", "MBA"
  allowedPassoutYears Int[] // Array for specific batches (e.g. 2023, 2025)
  passoutYearMin      Int?  // Range Optimization
  passoutYearMax      Int?  // Range Optimization
  allowedAvailability Availability[] // When candidate should be available
  requiredSkills      String[]
  locations           String[] // For DB-level filtering
  experienceMin       Int?     // Experience in years (e.g. 0)
  experienceMax       Int?     // Experience in years (e.g. 3)

  // Job/Internship Specific
  workMode       WorkMode?
  salaryMin      Int? // Legacy: Can map salaryRange to this
  salaryMax      Int?
  salaryRange    String? // New: "6-8 LPA"
  salaryPeriod   SalaryPeriod @default(YEARLY) // Default to Annual (India standard)
  incentives     String? // Optional: "Rs. 20k - 1L targets"
  jobFunction    String? // Optional: "Banking", "Sales", "Engineering"
  stipend        String? // New: "10k/month"
  employmentType String? // New: "full-time"
  applyLink      String?

  // Walk-in Specific (nullable for non-walk-ins)
  walkInDetails WalkInDetails?

  // Expiry Management
  expiresAt DateTime?
  expiredAt DateTime?
  status    OpportunityStatus @default(DRAFT) // Starts as draft

  // Soft Delete Support (PRODUCTION MUST-HAVE)
  deletedAt      DateTime? // Null = not deleted, set = soft deleted
  deletionReason String? // Why was it removed (audit trail)

  // Metadata - Referential Integrity with Admin
  postedByAdminId String
  admin           Admin    @relation(fields: [postedByAdminId], references: [id])
  postedAt        DateTime @default(now())
  lastVerified    DateTime @default(now())

  // Relations
  actions  UserAction[]
  feedback ListingFeedback[]

  // DB-level filtering indexes
  @@index([status])
  @@index([type])
  @@index([locations])
  @@index([expiresAt]) // Performance for expiry cron
  @@index([deletedAt]) // Exclude soft-deleted in queries
}

model WalkInDetails {
  id            String @id @default(uuid())
  opportunityId String @unique

  dates             DateTime[] // Multiple walk-in dates
  dateRange         String?    // New: "2nd Feb - 6th Feb"
  timeRange         String?    // New: "11:00 AM - 1:00 PM"
  venueAddress      String     @db.Text
  venueLink         String?    // New: Google Maps URL
  reportingTime     String
  requiredDocuments String[]
  contactPerson     String?
  contactPhone      String?

  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
}

// ============================================================================
// USER TRACKING MODELS
// ============================================================================

model UserAction {
  id            String     @id @default(uuid())
  userId        String
  opportunityId String
  actionType    ActionType // Enum
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@unique([userId, opportunityId])
}

model ListingFeedback {
  id            String         @id @default(uuid())
  userId        String
  opportunityId String
  reason        FeedbackReason // Enum
  createdAt     DateTime       @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@unique([userId, opportunityId]) // One feedback per user per listing
}
